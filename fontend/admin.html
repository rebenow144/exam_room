<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Exam Room Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" data-bs-backdrop="static" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Admin Login</h5>
                </div>
                <div class="modal-body">
                    <form id="loginForm">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container-fluid" style="display: none;" id="mainContent">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar py-3">
                <div class="position-sticky">
                    <div class="list-group">
                        <a href="#" class="list-group-item list-group-item-action active" id="examRoomsLink">
                            <i class="fas fa-door-open me-2"></i>Exam Rooms
                        </a>
                        <a href="#" class="list-group-item list-group-item-action" id="logoutLink">
                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main area -->
            <div class="col-md-9 col-lg-10 ms-sm-auto px-4 py-3">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
                    <h1>Exam Room Management</h1>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#examRoomModal">
                        <i class="fas fa-plus me-2"></i>Add New Room
                    </button>
                </div>

                <!-- Room List -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Room Name</th>
                                <th>Total Seats</th>
                                <th>Booked Seats</th>
                                <th>Exam Date</th>
                                <th>Exam Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="roomList">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Room Modal -->
    <div class="modal fade" id="examRoomModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add New Exam Room</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="roomForm">
                        <input type="hidden" id="roomId">
                        <div class="mb-3">
                            <label class="form-label">Room Name</label>
                            <input type="text" class="form-control" id="roomName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Total Seats</label>
                            <input type="number" class="form-control" id="totalSeats" required min="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Exam Date</label>
                            <input type="date" class="form-control" id="examDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Exam Time (HH:MM)</label>
                            <input type="text" class="form-control" id="examTime" required 
                                   placeholder="Format: 09:00" pattern="^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$">
                            <div class="invalid-feedback">
                                Please enter a valid time in 24-hour format (e.g., 09:00, 13:30, 23:00)
                            </div>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>


    <!-- Candidate List Modal -->
    <div class="modal fade" id="candidateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Candidate List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>University</th>
                                    <th>Email</th>
                                    <th>Phone</th>
                                    <th>Seat No.</th>
                                </tr>
                            </thead>
                            <tbody id="candidateList"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let loginModal;
        let examRoomModal;
        let candidateModal;
        let currentAdmin = null;

        // Initialize on document load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize modals
            loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            examRoomModal = new bootstrap.Modal(document.getElementById('examRoomModal'));
            candidateModal = new bootstrap.Modal(document.getElementById('candidateModal'));

            // Show login modal on start
            loginModal.show();

            // Add event listeners
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('roomForm').addEventListener('submit', handleRoomSubmit);
            document.getElementById('logoutLink').addEventListener('click', handleLogout);

            // Set minimum date for exam date input
            document.getElementById('examDate').min = new Date().toISOString().split('T')[0];
        });

        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch('http://localhost:5000/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    currentAdmin = await response.json();
                    loginModal.hide();
                    document.getElementById('mainContent').style.display = 'block';
                    loadExamRooms();
                } else {
                    alert('Invalid credentials');
                }
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        // Load exam rooms
        async function loadExamRooms() {
            try {
                const response = await fetch('http://localhost:5000/examrooms');
                const rooms = await response.json();
                
                const roomList = document.getElementById('roomList');
                roomList.innerHTML = '';
                
                rooms.forEach(room => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${room.room_name}</td>
                        <td>${room.total_seats}</td>
                        <td>${room.booked_seats || 0}</td>
                        <td>${new Date(room.exam_date).toLocaleDateString()}</td>
                        <td>${room.exam_time}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="viewCandidates(${room.room_id})">
                                <i class="fas fa-users"></i>
                            </button>
                            <button class="btn btn-sm btn-warning me-1" onclick="editRoom(${room.room_id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRoom(${room.room_id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    roomList.appendChild(row);
                });
            } catch (error) {
                alert('Error loading exam rooms: ' + error.message);
            }
        }

        // Handle room form submission
        async function handleRoomSubmit(e) {
            e.preventDefault();
            
            const examTimeInput = document.getElementById('examTime');
            const timePattern = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            
            // Validate time format
            if (!timePattern.test(examTimeInput.value)) {
                examTimeInput.classList.add('is-invalid');
                return;
            }
            
            const roomId = document.getElementById('roomId').value;
            const roomData = {
                room_name: document.getElementById('roomName').value,
                total_seats: document.getElementById('totalSeats').value,
                exam_date: document.getElementById('examDate').value,
                exam_time: examTimeInput.value
            };

            try {
                const url = roomId ? 
                    `http://localhost:5000/examrooms/${roomId}` : 
                    'http://localhost:5000/examrooms';
                
                const response = await fetch(url, {
                    method: roomId ? 'PUT' : 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(roomData)
                });

                if (response.ok) {
                    examRoomModal.hide();
                    loadExamRooms();
                    document.getElementById('roomForm').reset();
                    examTimeInput.classList.remove('is-invalid');
                } else {
                    const error = await response.json();
                    alert(error.message);
                }
            } catch (error) {
                alert('Error saving exam room: ' + error.message);
            }
        }

        // View candidates in a room
        async function viewCandidates(roomId) {
            try {
                const response = await fetch(`http://localhost:5000/examrooms/${roomId}/candidates`);
                const candidates = await response.json();
                
                const candidateList = document.getElementById('candidateList');
                candidateList.innerHTML = '';
                
                candidates.forEach(candidate => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${candidate.first_name} ${candidate.last_name}</td>
                        <td>${candidate.university}</td>
                        <td>${candidate.email}</td>
                        <td>${candidate.phone}</td>
                        <td>${candidate.seat_number}</td>
                    `;
                    candidateList.appendChild(row);
                });
                
                candidateModal.show();
            } catch (error) {
                alert('Error loading candidates: ' + error.message);
            }
        }

        // Edit room
        async function editRoom(roomId) {
            try {
                const response = await fetch(`${API_URL}/examrooms`);
                const rooms = await response.json();
                const room = rooms.find(r => r.room_id === roomId);

                document.getElementById('editRoomId').value = roomId;
                document.getElementById('editRoomName').value = room.room_name;
                document.getElementById('editTotalSeats').value = room.total_seats;
                document.getElementById('editExamDate').value = formatDateForInput(room.exam_date);
                document.getElementById('editExamTime').value = room.exam_time;

                editModal.show();
            } catch (error) {
                alert('เกิดข้อผิดพลาดในการโหลดข้อมูล');
            }
        }

        // Add time input validation on change
        document.getElementById('examTime').addEventListener('input', function(e) {
            const timePattern = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            if (timePattern.test(this.value)) {
                this.classList.remove('is-invalid');
            } else {
                this.classList.add('is-invalid');
            }
        });

        // Delete room
        async function deleteRoom(roomId) {
            if (confirm('Are you sure you want to delete this room?')) {
                try {
                    const response = await fetch(`http://localhost:5000/examrooms/${roomId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        loadExamRooms();
                    } else {
                        const error = await response.json();
                        alert(error.message);
                    }
                } catch (error) {
                    alert('Error deleting room: ' + error.message);
                }
            }
        }

        // Handle logout
        function handleLogout() {
            currentAdmin = null;
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('loginForm').reset();
            loginModal.show();
        }
    </script>
</body>
</html>