<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจองห้องสอบ</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        .room-card {
            transition: transform 0.2s;
        }
        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .booking-history {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">ระบบจองห้องสอบ</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" onclick="showAvailableRooms()">ห้องสอบที่ว่าง</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showBookingHistory()">ประวัติการจอง</a>
                    </li>
                </ul>
            </div>
            <!-- User Info (Mock) -->
            <span class="navbar-text text-white">
                User ID: <span id="userId">1</span>
            </span>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Available Rooms Section -->
        <div id="availableRooms" class="row g-4">
            <!-- Rooms will be loaded here -->
        </div>

        <!-- Booking History Section -->
        <div id="bookingHistory" class="booking-history mt-4" style="display: none;">
            <h3>ประวัติการจอง</h3>
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ห้องสอบ</th>
                            <th>วันที่สอบ</th>
                            <th>เวลาสอบ</th>
                            <th>วันที่จอง</th>
                            <th>การดำเนินการ</th>
                        </tr>
                    </thead>
                    <tbody id="bookingHistoryBody">
                        <!-- Booking history will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JavaScript -->
    <script>
        const API_URL = 'http://localhost:5001';
        const userId = document.getElementById('userId').textContent;

        // แสดงห้องสอบที่ว่าง
        async function showAvailableRooms() {
            try {
                document.getElementById('availableRooms').style.display = 'flex';
                document.getElementById('bookingHistory').style.display = 'none';

                const response = await fetch(`${API_URL}/available-examrooms`);
                const rooms = await response.json();

                const roomsContainer = document.getElementById('availableRooms');
                roomsContainer.innerHTML = rooms.map(room => `
                    <div class="col-md-4">
                        <div class="card room-card">
                            <div class="card-body">
                                <h5 class="card-title">${room.room_name}</h5>
                                <p class="card-text">
                                    วันที่สอบ: ${new Date(room.exam_date).toLocaleDateString('th-TH')}<br>
                                    เวลาสอบ: ${room.exam_time}<br>
                                    ที่นั่งว่าง: ${room.available_seats}
                                </p>
                                <button onclick="bookRoom(${room.room_id})" class="btn btn-primary">จองห้องสอบ</button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
                alert('เกิดข้อผิดพลาดในการโหลดข้อมูลห้องสอบ');
            }
        }

        // จองห้องสอบ
        async function bookRoom(roomId) {
            try {
                const response = await fetch(`${API_URL}/bookings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: parseInt(userId),
                        room_id: roomId
                    })
                });

                const result = await response.json();
                if (response.ok) {
                    alert('จองห้องสอบสำเร็จ');
                    showAvailableRooms();
                } else {
                    alert(result.message || 'เกิดข้อผิดพลาดในการจองห้องสอบ');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('เกิดข้อผิดพลาดในการจองห้องสอบ');
            }
        }

        // แสดงประวัติการจอง
        async function showBookingHistory() {
            try {
                document.getElementById('availableRooms').style.display = 'none';
                document.getElementById('bookingHistory').style.display = 'block';

                const response = await fetch(`${API_URL}/bookings/${userId}`);
                const bookings = await response.json();

                const historyBody = document.getElementById('bookingHistoryBody');
                historyBody.innerHTML = bookings.map(booking => `
                    <tr>
                        <td>${booking.room_name}</td>
                        <td>${new Date(booking.exam_date).toLocaleDateString('th-TH')}</td>
                        <td>${booking.exam_time}</td>
                        <td>${new Date(booking.booking_date).toLocaleString('th-TH')}</td>
                        <td>
                            <button onclick="cancelBooking(${booking.booking_id})" class="btn btn-danger btn-sm">
                                ยกเลิกการจอง
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
                alert('เกิดข้อผิดพลาดในการโหลดประวัติการจอง');
            }
        }

        // ยกเลิกการจอง
        async function cancelBooking(bookingId) {
            if (confirm('คุณต้องการยกเลิกการจองห้องสอบนี้ใช่หรือไม่?')) {
                try {
                    const response = await fetch(`${API_URL}/bookings/${bookingId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        alert('ยกเลิกการจองสำเร็จ');
                        showBookingHistory();
                    } else {
                        alert('เกิดข้อผิดพลาดในการยกเลิกการจอง');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('เกิดข้อผิดพลาดในการยกเลิกการจอง');
                }
            }
        }

        // โหลดห้องสอบที่ว่างเมื่อเปิดหน้าเว็บ
        showAvailableRooms();
    </script>
</body>
</html>